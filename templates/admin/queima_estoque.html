{% extends "base.html" %}

{% block title %}Queima de Estoque{% endblock %}

{% block content %}
<div class="admin-container">
    <h1>Gerenciar Queima de Estoque</h1>

    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline mb-3">‚Üê Voltar</a>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">üì¶ Produtos em Queima de Estoque</h3>
            <p style="margin: 0; font-size: 24px; font-weight: bold; color: #ffc107;">{{ produtos_queima|length }}</p>
        </div>
        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0066cc;">
            <h3 style="margin: 0 0 10px 0; color: #004085;">üìä Produtos Normais</h3>
            <p style="margin: 0; font-size: 24px; font-weight: bold; color: #0066cc;">{{ produtos_normais|length }}</p>
        </div>
    </div>

    <!-- Filtro de busca -->
    <div style="margin-bottom: 20px;">
        <input type="text" id="searchInput" placeholder="üîç Buscar produto..." 
               style="width: 100%; padding: 12px 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px;">
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <!-- Produtos em Queima de Estoque -->
        <div>
            <h2 style="color: #ffc107; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">üî• Em Queima de Estoque</h2>
            
            {% if produtos_queima %}
                <div id="queima-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 600px; overflow-y: auto;">
                    {% for produto in produtos_queima %}
                    <div class="produto-item queima-item" data-id="{{ produto.id }}" data-nome="{{ produto.nome }}" 
                         style="background: #fff9e6; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>{{ produto.nome }}</strong>
                            <br>
                            <small style="color: #666;">ID: {{ produto.id }}</small>
                            <br>
                            {% if produto.get('preco_original') or produto.get('preco_queima') %}
                            <div style="margin-top: 8px; padding: 8px; background: #fff; border-radius: 4px;">
                                {% if produto.get('preco_original') %}
                                <span style="text-decoration: line-through; color: #999;">R$ {{ "%.2f"|format(produto.preco_original) }}</span>
                                {% endif %}
                                {% if produto.get('preco_queima') %}
                                <strong style="color: #ff6b35; font-size: 16px; margin-left: 10px;">
                                    R$ {{ "%.2f"|format(produto.preco_queima) }}
                                </strong>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <button class="btn btn-warning" onclick="toggleQueima({{ produto.id }}, this)" 
                                style="padding: 6px 12px; font-size: 14px; white-space: nowrap; margin-left: 10px;">
                            ‚úì Remover
                        </button>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p style="color: #999; text-align: center; padding: 40px 20px;">Nenhum produto em queima de estoque</p>
            {% endif %}
        </div>

        <!-- Produtos Normais -->
        <div>
            <h2 style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 10px;">üì¶ Produtos Dispon√≠veis</h2>
            
            {% if produtos_normais %}
                <div id="normal-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 600px; overflow-y: auto;">
                    {% for produto in produtos_normais %}
                    <div class="produto-item normal-item" data-id="{{ produto.id }}" data-nome="{{ produto.nome }}"
                         style="background: #f0f8ff; border: 1px solid #0066cc; border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>{{ produto.nome }}</strong>
                            <br>
                            <small style="color: #666;">ID: {{ produto.id }}</small>
                        </div>
                        <button class="btn btn-primary" onclick="toggleQueima({{ produto.id }}, this)" 
                                style="padding: 6px 12px; font-size: 14px; white-space: nowrap; margin-left: 10px;">
                            + Adicionar
                        </button>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p style="color: #999; text-align: center; padding: 40px 20px;">Todos os produtos est√£o em queima de estoque</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para editar pre√ßos -->
<div id="priceModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 400px;">
        <h3>Definir Pre√ßos - <span id="productName"></span></h3>
        
        <div style="margin-bottom: 15px;">
            <label for="priceOriginal">Pre√ßo Original (R$)</label>
            <input type="number" id="priceOriginal" placeholder="Ex: 50.00" step="0.01" min="0" 
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label for="priceQueima">Pre√ßo de Queima (R$)</label>
            <input type="number" id="priceQueima" placeholder="Ex: 20.00" step="0.01" min="0"
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <p id="pricePreview" style="font-size: 14px; color: #666;"></p>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-outline" onclick="closePriceModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="savePrices()">Salvar Pre√ßos</button>
        </div>
    </div>
</div>

<style>
    .produto-item {
        transition: all 0.3s ease;
    }
    
    .produto-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateX(5px);
    }
    
    .btn-warning {
        background-color: #ffc107;
        color: #000;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .btn-warning:hover {
        background-color: #ffb700;
        transform: scale(1.05);
    }
    
    .btn-primary {
        background-color: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .btn-primary:hover {
        background-color: #0052a3;
        transform: scale(1.05);
    }
    
    .btn-outline {
        background-color: white;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        padding: 8px 16px;
        transition: all 0.2s;
    }
    
    .btn-outline:hover {
        background-color: #f5f5f5;
    }
</style>

<script>
let currentProductId = null;

// Filtro de busca
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    // Filtrar itens em queima
    document.querySelectorAll('.queima-item').forEach(item => {
        const nome = item.dataset.nome.toLowerCase();
        item.style.display = nome.includes(searchTerm) ? '' : 'none';
    });
    
    // Filtrar itens normais
    document.querySelectorAll('.normal-item').forEach(item => {
        const nome = item.dataset.nome.toLowerCase();
        item.style.display = nome.includes(searchTerm) ? '' : 'none';
    });
});

async function toggleQueima(productId, button) {
    currentProductId = productId;
    
    try {
        const response = await fetch(`/admin/queima-estoque/toggle/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Erro desconhecido');
        }
        
        if (data.success) {
            // Se foi adicionado √† queima, pedir para definir pre√ßos
            if (data.em_queima_estoque) {
                showPriceModal(productId, button.closest('.produto-item').querySelector('strong').textContent);
            } else {
                // Se foi removido, recarregar
                setTimeout(() => location.reload(), 300);
            }
        } else {
            throw new Error(data.error || 'Erro ao atualizar produto');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar produto: ' + error.message);
    }
}

function showPriceModal(productId, productName) {
    currentProductId = productId;
    document.getElementById('productName').textContent = productName;
    document.getElementById('priceOriginal').value = '';
    document.getElementById('priceQueima').value = '';
    document.getElementById('pricePreview').innerHTML = '';
    document.getElementById('priceModal').style.display = 'block';
}

function closePriceModal() {
    document.getElementById('priceModal').style.display = 'none';
    currentProductId = null;
}

// Atualizar preview de pre√ßo
document.getElementById('priceOriginal').addEventListener('input', updatePricePreview);
document.getElementById('priceQueima').addEventListener('input', updatePricePreview);

function updatePricePreview() {
    const original = parseFloat(document.getElementById('priceOriginal').value) || 0;
    const queima = parseFloat(document.getElementById('priceQueima').value) || 0;
    
    if (original > 0 && queima > 0) {
        const desconto = ((original - queima) / original * 100).toFixed(1);
        const preview = `<strong style="color: #ff6b35; font-size: 16px;">
            <span style="text-decoration: line-through; color: #999;">R$ ${original.toFixed(2)}</span>
            por <span style="color: #ff6b35;">R$ ${queima.toFixed(2)}</span>
        </strong>
        <br><span style="color: #28a745; font-weight: bold;">Economia: ${desconto}%</span>`;
        document.getElementById('pricePreview').innerHTML = preview;
    }
}

async function savePrices() {
    const original = parseFloat(document.getElementById('priceOriginal').value);
    const queima = parseFloat(document.getElementById('priceQueima').value);
    
    if (!original || !queima) {
        alert('Preencha os dois pre√ßos');
        return;
    }
    
    if (queima >= original) {
        alert('O pre√ßo de queima deve ser menor que o pre√ßo original');
        return;
    }
    
    try {
        const response = await fetch(`/admin/queima-estoque/save-prices/${currentProductId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                preco_original: original,
                preco_queima: queima
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closePriceModal();
            setTimeout(() => location.reload(), 300);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar pre√ßos');
    }
}

// Fechar modal ao clicar fora
document.getElementById('priceModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePriceModal();
    }
});
</script>
{% endblock %}

